<?php

/**
 * Profiles
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    RootlessMe
 * @subpackage model
 * @author     awilliams
 * @version    SVN: $Id: Builder.php 7691 2011-02-04 15:43:29Z jwage $
 */
class Profiles extends BaseProfiles
{
    public function getFullName()
    {
        $fullName = $this->getFirstName();
        if ($this->getFirstName() != null && $this->getLastName() != null)
        {
            $fullName = $fullName . " ";
        }
        $fullName = $fullName . $this->getLastName();
        return $fullName;
    }

    public function getAge()
    {

        $birth_date = $this->getBirthday();
        //Make sure the birth date is specified
        if(!$birth_date)
        {
            // If not, return null
            return null;
        }
        list($birth_year,$birth_month,$birth_day) = explode("-", $birth_date);
        $year_diff=date("Y")-$birth_year;
        $this_birthday=date("Y").$birth_month.$birth_day;
        $date=date("Ymd");

        if($this_birthday>$date){
            $year_diff--;
        }

        return $year_diff;

    }

    public function isMyFriend()
    {
        $myId = sfContext::getInstance()->getUser()->getGuardUser()->getPersonId();
        $profileId = $this->getPersonId();

        // Need sql to match this query
        // select * from friendships f
        // where f.friend1_id = 1 and f.friend2_id = 2
        //    or f.friend2_id = 1 and f.friend1_id = 2;
//        $q = $this->createQuery('f')
        $q = Doctrine_Query::create()
                ->select('profile_name')
                ->from('friendships f')
                ->where('f.friend1_id = ? AND f.friend2_id = ?', array($myId, $profileId))
                ->orWhere('f.friend2_id = ? AND f.friend1_id = ?', array($myId, $profileId));

        // Return a boolean indicating whether there was a friendship
        // record found.
        return ($q->count() > 0) ;
    }

    public function save(Doctrine_Connection $conn = null)
    {
        // Get the connection information
        $conn = $conn ? $conn : $this->getTable()->getConnection();
        // Begin a transaction so it can be rolled back if something goes
        // wrong
        $conn->beginTransaction();
        try
        {
            // Save the profile
            $ret = parent::save($conn);
            // Update the Lucene search index
            $this->updateLuceneIndex();
            // Commit the transaction
            $conn->commit();

            return $ret;
        }
        catch (Exception $e)
        {
            $conn->rollBack();
            throw $e;
        }
    }

    public function delete(Doctrine_Connection $conn = null)
    {
        // Remove the profile from the Lucene search index
        $index = ProfilesTable::getLuceneIndex();
        foreach ($index->find('pk:'.$this->getId()) as $hit)
        {
            $index->delete($hit->id);
        }

        // Remove the profile from the database
        return parent::delete($conn);
    }

    public function updateLuceneIndex()
    {
        $index = ProfilesTable::getLuceneIndex();

        // remove existing entries
        foreach ($index->find('profileName:'.$this->getProfileName()) as $hit)
        {
            $index->delete($hit->id);
        }

        // don't index expired and non-activated jobs
//        if ($this->isExpired() || !$this->getIsActivated())
//        {
//            return;
//        }

        $doc = new Zend_Search_Lucene_Document();

        // store profile primary key to identify it in the search results
        $doc->addField(Zend_Search_Lucene_Field::Keyword('profileName', $this->getProfileName()));

        // index profile fields
        $doc->addField(Zend_Search_Lucene_Field::UnStored('firstName', $this->getFirstName(), 'utf-8'));
        $doc->addField(Zend_Search_Lucene_Field::UnStored('lastName', $this->getLastName(), 'utf-8'));

        // add profile to the index
        $index->addDocument($doc);
        $index->commit();
    }
}